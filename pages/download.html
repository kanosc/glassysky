<!DOCTYPE html>
<html lang="en">
<head>
    <title>online storage</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
</head>
<body>
<div class="container mt-3">
    <div class="container mt-5 mb-3 pb-3 border-bottom">
	    <h1 class="text-center">在线文件存储系统</h1>
    </div>
    {{ range .files }}
	<div class="card w-25 m-0 float-start bg-light text-white" id="{{ DelPoint . }}">
        <div class="card-body">
			<h6 class="card-title text-black text-nowrap overflow-hidden">{{ . }}</h6>
			<p class="card-text text-black"><hr></p>
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle btn-sm" data-bs-toggle="dropdown">操作</button>
                <ul class="dropdown-menu">
					<li><a class="dropdown-item download-btn" href="#" name="{{ . }}">下载</a></li>
                    <li><a class="dropdown-item delete-btn" href="#" name="{{ . }}" uname="{{ DelPoint . }}">删除</a></li>
                </ul>
            </div>
        </div>
    </div>
    {{ end }}
</div>
<script>
    $(document).ready(function(){
        $(".download-btn").click(function(){
			var filename = $(this).attr("name");
			var url = "https://glassysky.cn/resource/" + filename;
			var xhr = new XMLHttpRequest();
			xhr.open('GET', url, true);//get请求，请求地址，是否异步
			xhr.responseType = "blob";    // 返回类型blob
			xhr.onload = function () {// 请求完成处理函数
				if (this.status === 200) {
					var blob = this.response;// 获取返回值
					var a = document.createElement('a');
					a.download = filename;
					a.href=window.URL.createObjectURL(blob);
					a.click();
				}
			};
			// 发送ajax请求
			xhr.send();
        });
		$(".delete-btn").click(function(){
            var filename = $(this).attr("name");
			if (confirm("是否确认删除文件 " + filename) == false) {
                return;
            }
			var uname = $(this).attr("uname");
            var url = "https://glassysky.cn/delete?filename=" + filename;
            $.ajax({url:url,
                error:function(xhr){
                    alert("删除文件失败");
                },
                success:function(xhr){
                    alert("删除文件成功");
					$("#"+uname).remove();
				}
			});
		});
    });
</script>
</body>
</html>
